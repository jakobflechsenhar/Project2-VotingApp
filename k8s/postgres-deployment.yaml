#--------------------------------------------------------#
# Kubernetes Deployment: PostreSQL
#--------------------------------------------------------#

# PersistentVolumeClaim (PVC) requests 5GB storage from the cluster for database persistence across pod restarts.
# Deployment creates a PostgreSQL pod that runs PSQL version 15-Alpine, automatically creates a database named votes, creates a user named votes_user with password votes_password, and stores all data in persistent storage (survives pod restarts).
# Service exposes PostgreSQL on port 5432 as 'jakob-service-postgres' for internal cluster access


# PostgreSQL PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jakob-pvc-postgres
  namespace: jakob
spec:
  accessModes:
    - ReadWriteOnce                  # Single node read/write access
  storageClassName: gp2
  resources:
    requests:
      storage: 5Gi                   # Request 5GB storage
---
# PostgreSQL Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jakob-deployment-postgres
  namespace: jakob
spec:
  replicas: 1                         # Single PostgreSQL instance
  selector:
    matchLabels:
      app: jakob-postgres
      owner: jakob
  template:
    metadata:
      labels:
        app: jakob-postgres
        owner: jakob
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine      # Lightweight PostgreSQL image
        ports:
        - containerPort: 5432          # PostgreSQL default port
        env:
        - name: POSTGRES_DB
          value: votes                 # Database name
        - name: POSTGRES_USER
          value: votes_user            # Database username
        - name: POSTGRES_PASSWORD
          value: votes_password        # Database password
        resources:
          requests:
            memory: "128Mi"            # Minimum memory
            cpu: "100m"                # Minimum CPU (0.1 core)
          limits:
            memory: "256Mi"            # Maximum memory
            cpu: "200m"                # Maximum CPU (0.2 core)
        volumeMounts:
        - name: pgdata
          mountPath: /var/lib/postgresql/data  # PostgreSQL data directory
      volumes:
      - name: pgdata
        persistentVolumeClaim:
          claimName: jakob-pvc-postgres        # Link to PVC above
---
# PostgreSQL Service
apiVersion: v1
kind: Service
metadata:
  name: jakob-service-postgres
  namespace: jakob
spec:
  type: ClusterIP             # Internal cluster access only
  selector:
    app: jakob-postgres
    owner: jakob
  ports:
  - protocol: TCP
    port: 5432                # Service port
    targetPort: 5432          # Container port